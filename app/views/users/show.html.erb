<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API'] %>&callback=initMap"
async defer></script>
<script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('multi-markers'), {
          center: {lat: <%= @user.latitude %>, lng: <%= @user.longitude %>},
          zoom: 11,
          styles: [{"featureType":"all","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"visibility":"simplified"}]},{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#ff862f"},{"visibility":"on"}]}]
        });

        <% if @user %>
        var contentString<%=@user.id%> = '<div id="content">' +
            '<div id="siteNotice"><% unless current_user == @user %>' +
              '<%= link_to "Send message", new_message_path(to: @user.id), :class =>' + '"btn' + 'btn-default btn-sm" %>' +
            '<% end %>' +
            '</div>'+
            '<h1 id="firstHeading" class="firstHeading"><%=@user.user_name%></h1>'+
            '<div id="bodyContent"><p><b>Products Available:</b></p><ol>'+
            <% @user.products.each do |product| %>
            '<li><%=link_to product.name, product_path(product), :class => "btn btn-sm"%></li>'+
            <% end %>
            '</ol><p>Email: <%=@user.email%></p> <p>Go to: <%=link_to @user.user_name, user_path(@user) %></p>'+
            '</div>'+
            '</div>';

        var infowindow<%=@user.id%> = new google.maps.InfoWindow({
          content: contentString<%=@user.id%>
        });
        var marker<%=@user.id%> = new google.maps.Marker({
          position: {lat: <%=@user.latitude%>, lng: <%=@user.longitude%>},
          map: map,
          title: 'Hello World!'
        });
        marker<%=@user.id%>.addListener('click', function() {
          infowindow<%=@user.id%>.open(map, marker<%=@user.id%>);
        });
        <% end %>
      }
</script>

<div class="row container">
  <h1 class="field"><%= @user.user_name %>'s User Page
    <span class="pull-right">Average Rating:
      <%= @avg_rating.times do %>
      <span class="stars">
        <span class="glyphicon glyphicon-star"></span>
      </span>
      <% end %>
    </span>
  </h1>
  <div class="col-md-7">
    <span class="product-homepage">
      <h3><%= @user.user_name %>'s Registered Location</h3>
      <div id="multi-markers" style='width: 600px; height: 400px;'></div>
    </span>
  </div>
  <div class="col-md-5">
    <h3><%= @user.user_name %>'s Bio</h3>
    <h5><%= @user.bio %></h5>
  </div>

</div>
<div class="row container"><hr>
  <% if current_user && current_user == @user %>
    <h4>Post a product you would like to trade</h4>
    <h4><%= link_to "Post", new_product_path, :class => "btn btn-success", :id => "new_product_link", remote: true %></h4>
  <% end %>
  <div class="col-sm-6">
    <h4>Products posted by <%= @user.user_name %></h4>
    <ul class="list-group well" id="products">
        <%= content_tag_for(:li, @user.products.each, class: "list-group-item") do |product| %>
        <%= link_to product.name, category_product_path(product.category, product)%>
        <span class="pull-right"><strong>Category: </strong><%= link_to product.category.name, category_path(product.category)%></span>
        <br>
        <%= image_tag(product.image.url(:thumb)) %>
        <% end %>
    </ul>
  </div>
  <div class="col-sm-6">
    <h5>Reviews of <%= @user.user_name %></h5>
    <ul class="list-group well">
      <% @user.reviews.order('votes desc').each do |review| %>
        <li class="list-group-item">
          <span class="pull-right voter">
            <%= link_to upvote_path(review), :method => "post", remote: true, :class => "btn btn-success" do %>
              <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
            <% end %>
            <h4 id="<%=review.id.to_s%>-votes"><%= review.votes %></h4>
            <%= link_to downvote_path(review), :method => "post", remote: true, :class => "btn btn-danger" do %>
              <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
            <% end %>
          </span>
          <h5>
            <span class="field">
            <%= link_to User.find(review.author_id).user_name, user_path(User.find(review.author_id)) %> rated <strong><%= @user.user_name %></strong>
            <%= review.rating.times do %>
              <span class="stars">
                <span class="glyphicon glyphicon-star"></span>
              </span>
            <% end %>
            <% if 1 == 0 %>
            <% (5 - review.rating).times do %>
              <span class="stars">
                <span class="glyphicon glyphicon-star-empty"></span>
              </span>
            <% end %>
            <% end %>
            </span>
          </h4>
          <br>
          <p><em>Rating Description:</em> <%= review.content %></p>
          <%= link_to "Rating Page", user_review_path(User.find(review.author_id), review)%>
          <br>
        </li>
        <br>
      <% end %>
    </ul>
    <% if current_user && @user != current_user %>
      <span>
        <%= link_to "Write a Review for " + @user.user_name, new_user_review_path(@user), :class => "btn btn-lg btn-success" %>
      </span>
    <% end %>
  </div>
</div>
