<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsrciFSZIHPIokQFpVQo6i4boOCSu33w8&callback=initMap"
async defer></script>
<script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('multi-markers'), {
          center: {lat: <%= @user.latitude %>, lng: <%= @user.longitude %>},
          zoom: 11,
          styles: [{"featureType":"all","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"visibility":"simplified"}]},{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#558C89"},{"visibility":"on"}]}]
        });

        <% if @user %>
          var contentString<%=@user.id%> = '<div id="content">' +
              '<div id="siteNotice"><% unless current_user == @user %>' +
                '<%= link_to "Send message", new_message_path(to: @user.id), :class =>' + '"btn' + 'btn-default btn-sm" %>' +
              '<% end %>' +
              '</div>'+
              '<h2 id="firstHeading" class="firstHeading"><%=@user.user_name%></h2>'+
              '<div id="bodyContent"><p><b>Products Available:</b></p><ol>'+
              <% @user.products.each do |product| %>
              '<li><%=link_to product.name, product_path(product), :class => ""%></li>'+
              <% end %>
              '</ol><p>Email: <%=@user.email%></p> <p>Go to: <%=link_to @user.user_name, user_path(@user) %></p>'+
              '</div>'+
              '</div>';

          var infowindow<%=@user.id%> = new google.maps.InfoWindow({
            content: contentString<%=@user.id%>
          });
          var marker<%=@user.id%> = new google.maps.Marker({
            position: {lat: <%=@user.latitude%>, lng: <%=@user.longitude%>},
            map: map,
            label: "<%= @user.user_name[0] + @user.user_name[1] %>",
            title: 'Hello World!'
          });
          marker<%=@user.id%>.addListener('click', function() {
            infowindow<%=@user.id%>.open(map, marker<%=@user.id%>);
          });
        <% end %>
        <% if @user && current_user.id != @user.id %>
          var directionsService = new google.maps.DirectionsService();
          var directionsDisplay = new google.maps.DirectionsRenderer({
            suppressMarkers: true
          });
          directionsDisplay.setMap(map)
          directionsDisplay.setPanel(document.getElementById('directions-panel'));
          calcRoute(directionsService, directionsDisplay)
          var current_userContentString<%=current_user.id%> = '<div id="content">' +
              '<div id="siteNotice">' +
                '</div>'+
                  '<h2 id="firstHeading" class="firstHeading"><%=current_user.user_name%> Location</h2>' +
                '</div>' +
              '</div>';
          var current_userInfowindow<%=current_user.id%> = new google.maps.InfoWindow({
            content: current_userContentString<%=current_user.id%>
          });
          var current_userMarker<%=current_user.id%> = new google.maps.Marker({
            position: {lat: <%=current_user.latitude%>, lng: <%=current_user.longitude%>},
            map: map,
            label: "<%= current_user.user_name[0] + current_user.user_name[1] %>",
            title: 'Hello World!'
          });
          current_userMarker<%=current_user.id%>.addListener('click', function() {
            current_userInfowindow<%=current_user.id%>.open(map, current_userMarker<%=current_user.id%>);
          });
          $('#directions-panel').hide()
          $('#hide-directions').hide()
          $('#show-directions').on('click', function() {
            $('#directions-panel').show()
            $('#hide-directions').show()
            $('#show-directions').hide()
          })
          $('#hide-directions').on('click', function() {
            $('#directions-panel').hide()
            $('#hide-directions').hide()
            $('#show-directions').show()
          })
        <% end %>
      }

        function calcRoute(directionsService, directionsDisplay) {
          var request = {
            origin: {lat: <%= current_user.latitude%>, lng: <%= current_user.longitude %>},
            destination: {lat: <%=@user.latitude%>, lng: <%=@user.longitude%>},
            travelMode: 'DRIVING'
          };
          directionsService.route(request, function(result, status) {
            if (status == 'OK') {
              directionsDisplay.setDirections(result);
            }
          });
        }
</script>

<div class="row container">
  <h1 class="field"><%= @user.user_name.capitalize %>'s User Page
    <span class="pull-right">
      <% if @user.ratings %>
        Average Rating:
        <%= @user.ratings.times do %>
        <span class="stars">
          <span class="glyphicon glyphicon-star"></span>
        </span>
        <% end %>
      <% else %>
        <%= @user.user_name.capitalize %> has no ratings
      <% end %>
    </span>
  </h1>
  <div class="col-md-8 col-md-offset-2">
    <span class="product-homepage">
      <h3><%= @user.user_name.capitalize %>'s Registered Location</h3>
      <div id="multi-markers" style='width: 730px; height: 550px;'></div>
      <% if current_user.id != @user.id %>
        <button id="show-directions">Show Directions</button>
        <button id="hide-directions">Hide Directions</button>
        <div id="directions-panel" style="width:500px;"></div>
      <% end %>
      <hr>
      <h3><%= @user.user_name.capitalize %>'s Bio</h3>
      <h5><%= @user.bio %></h5>
    </span>
  </div>
</div>
<div class="row container"><hr>
  <% if current_user && current_user == @user %>
    <h4>Post a product you would like to trade</h4>
    <h4><%= link_to "Post", new_product_path, :class => "btn btn-success", :id => "new_product_link" %></h4>
  <% end %>
  <div class="col-sm-6">
    <h4>Products posted by <%= @user.user_name %></h4>
    <ul class="list-group well" id="products">
        <%= content_tag_for(:li, @user.products.each, class: "list-group-item") do |product| %>
        <%= link_to product.name, category_product_path(product.category, product)%>
        <span class="pull-right"><strong>Category: </strong><%= link_to product.category.name, category_path(product.category)%></span>
        <br>
        <%= image_tag(product.image.url(:thumb)) %>
        <% end %>
    </ul>
  </div>
  <div class="col-sm-6">
    <h5>Reviews of <%= @user.user_name %></h5>
    <ul class="list-group well">
      <% @user.reviews.order('votes desc').each do |review| %>
        <li class="list-group-item">
          <span class="pull-right voter">
            <%= link_to upvote_path(review), :method => "post", remote: true, :class => "btn btn-success" do %>
              <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
            <% end %>
            <h4 id="<%=review.id.to_s%>-votes" class="be-grey"><%= review.votes %></h4>
            <%= link_to downvote_path(review), :method => "post", remote: true, :class => "btn btn-danger" do %>
              <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
            <% end %>
          </span>
          <h5 class="be-grey">
            <span class="field pull-left">
            <%= link_to User.find(review.author_id).user_name, user_path(User.find(review.author_id)) %> rated <strong><%= @user.user_name %></strong>
            <%= review.rating.times do %>
              <span class="stars">
                <span class="glyphicon glyphicon-star"></span>
              </span>
            <% end %>
            <% if 1 == 0 %>
            <% (5 - review.rating).times do %>
              <span class="stars">
                <span class="glyphicon glyphicon-star-empty"></span>
              </span>
            <% end %>
            <% end %>
            </span>
          </h4>
          <br>
          <br>
          <p><em>Rating Description:</em> <%= review.content %></p>
          <%= link_to "Rating Page", user_review_path(User.find(review.author_id), review)%>
          <br>
        </li>
        <br>
      <% end %>
    </ul>
    <% if current_user && @user != current_user %>
      <span>
        <%= link_to "Write a Review for " + @user.user_name, new_user_review_path(@user), :class => "btn btn-lg btn-success" %>
      </span>
    <% end %>
  </div>
</div>
